# OceaGPX - 仕様書

## 概要

OceanPlotのSQLiteデータベースから航跡データを読み込み、GPXファイルとして出力するMacアプリケーション。
出力したGPXはLightroom Classicに読み込んで写真のジオタグ付与に使用する。

## 技術スタック

- **プラットフォーム**: macOS（Electronアプリ）
- **言語**: TypeScript
- **UIフレームワーク**: MUI (Material UI)
- **地図ライブラリ**: Leaflet + React-Leaflet
- **データベース**: SQLite（better-sqlite3）

## データベース仕様

詳細は [db.dbml](./db.dbml) を参照。

### 使用テーブル

| テーブル | 用途 |
|---------|------|
| LCHFIL | 記録のヘッダ情報（記録名、開始・終了時刻、航行距離） |
| LOCFIL | GPS位置データ（時刻、緯度、経度、速度、精度） |
| PINFIL | ピン情報（**GPX出力対象外**） |

### リレーション

```
LCHFIL.LCHレコードID ← LOCFIL.LOCレコードID
```

## 機能要件

### 1. データベース選択

- **ファイルダイアログ**: 「選択...」ボタンでDBファイル（.db）を選択
- **ドラッグ&ドロップ**: ウィンドウにDBファイルをD&Dで読み込み
  - ドロップ時にハイライト表示でフィードバック
  - .db以外のファイルは無視
- 選択したDBファイルのパスを記憶（次回起動時に復元）

### 2. 記録一覧表示

LCHFILテーブルの内容をテーブル形式で表示：

| 表示項目 | カラム | 備考 |
|---------|--------|------|
| 選択チェックボックス | - | 複数選択対応 |
| 記録名 | LCH記録名 | |
| 開始日時 | LCH開始時刻 | YYYY/MM/DD HH:mm形式 |
| 終了日時 | LCH終了時刻 | YYYY/MM/DD HH:mm形式 |
| 航行距離 | LCH航行距離 | km単位で表示 |
| ポイント数 | COUNT(LOCFIL) | 対応するLOCFILレコード数 |

#### 機能

- ソート（各カラムでソート可能）
  - **デフォルト**: 開始日時の降順（新しい順）
- フィルタ（記録名での検索）
- 全選択 / 全解除

### 3. 地図プレビュー

選択した記録の航跡を地図上に表示：

- **地図タイル**: OpenStreetMap
- **航跡表示**: ポリライン（色分け対応：複数選択時）
- **開始・終了点**: マーカー表示
- **自動フィット**: 選択した航跡が全て収まるようにズーム調整

### 4. GPX出力

#### 出力モード

1. **単一出力**: 1つの記録を1つのGPXファイルとして出力
2. **結合出力**: 複数の記録を1つのGPXファイルにまとめて出力

#### 出力先設定

- **都度選択**: 保存ダイアログで毎回指定
- **固定フォルダ**: 設定で指定したフォルダに自動保存
- デフォルトフォルダの設定＋出力時に変更可能

#### ファイル名

- 単一出力: `{記録名}_{開始日時}.gpx`
- 結合出力: `{開始日時}_{終了日時}.gpx` または ユーザー指定

#### GPXフォーマット

```xml
<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="OceaGPX"
     xmlns="http://www.topografix.com/GPX/1/1">
  <trk>
    <name>{記録名}</name>
    <trkseg>
      <trkpt lat="{緯度}" lon="{経度}">
        <time>{時刻}</time>
        <speed>{速度}</speed>
      </trkpt>
      <!-- 繰り返し -->
    </trkseg>
  </trk>
</gpx>
```

### 5. タイムゾーン処理

#### 方針

OceanPlotのデータはタイムゾーン情報を持たないローカルタイムで記録されている。
写真のEXIF時刻も同様にローカルタイムであるため、GPXにもローカルタイムをそのまま出力する。

#### 時刻フォーマット

```
2021-10-09T08:58:49
```

- ISO 8601形式
- タイムゾーン指定子（Z, +09:00など）は**付けない**
- これによりLightroom Classicで正しく時刻マッチングされる

## UI設計

### メインウィンドウ

```
┌─────────────────────────────────────────────────────────────┐
│ OceaGPX                                        [設定] [最小化][閉じる] │
├─────────────────────────────────────────────────────────────┤
│ DBファイル: [____________________] [選択...]                │
├─────────────────────────────────────────────────────────────┤
│                    │                                        │
│  記録一覧          │        地図プレビュー                  │
│  ┌────────────┐   │   ┌─────────────────────────────┐      │
│  │☑ 記録名    ...│   │                             │      │
│  │☐ 記録名    ...│   │      [航跡表示エリア]       │      │
│  │☑ 記録名    ...│   │                             │      │
│  │            │   │                             │      │
│  └────────────┘   │   └─────────────────────────────┘      │
│                    │                                        │
├─────────────────────────────────────────────────────────────┤
│ [全選択] [全解除]           [単一出力] [結合出力]           │
└─────────────────────────────────────────────────────────────┘
```

### ウィンドウ仕様

- **サイズ**: リサイズ可能
- **最小サイズ**: 1000 x 700
- **デフォルトサイズ**: 1400 x 900
- **サイズ・位置記憶**: 終了時のウィンドウ状態を保存し、次回起動時に復元

### 設定ダイアログ

- デフォルト出力先フォルダ
- 出力時に毎回フォルダを確認するかどうか

## 非機能要件

### パフォーマンス

- 10万ポイント以上の航跡もスムーズに地図表示
- 地図表示時はポイント間引き（Douglas-Peucker等）を適用

### データ整合性

- GPX出力前に必ず確認ダイアログ
- 出力成功時に通知

## 将来の拡張（スコープ外）

- 複数DBファイルの同時読み込み
- GPXからDBへのインポート
- 航跡の編集機能
- 写真との直接マッチング機能

---

**作成日**: 2024年12月29日
**バージョン**: 1.0.0
